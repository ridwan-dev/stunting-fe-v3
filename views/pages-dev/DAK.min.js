import WidgetCard from"../components/WidgetCard.js";import{ApiTahunDAK,ApiDataByTahun,apiAnggaranDak,ApiDakPeta}from"../../services/api.js";const DAK={render:async()=>{const widgetCard1=await WidgetCard.render("tile-1","Total Anggaran","transparent","lg-3 "),widgetCard2=await WidgetCard.render("tile-2","Top 5 Provinsi & Kota/ Kab","white-100","lg-6 "),widgetCard4=await WidgetCard.render("tile-4","3 Tahun Terakhir","light-100","lg-3");return`\n    <div class="app-content-padding flex-grow-1 overflow-auto" data-height="100%" >\n\t\t\t\t\x3c!-- BEGIN page-header --\x3e\n\t\t\t\t<h2 class="page-header text-blue"><i class="material-icons text-blue-600 align-middle me-1 mb-1">real_estate_agent</i>Dana Alokasi Khusus Fisik</h2>\n\t\t\t\t\x3c!-- END page-header --\x3e\n        \x3c!-- begin widget-card --\x3e        \n        <div id="fbody">\n          <div class="row card-deck">\n            ${widgetCard1}\n            ${widgetCard2}\n            ${widgetCard4}\n          </div>\n        \x3c!-- end widget-card --\x3e        \n        \x3c!-- begin widget-map --\x3e\n          <div class="border rounded mt-4 p-2">\n            <div class="row pt-2">\n              <div class="col-sm-12 col-xl-7 col-lg-8">\n                <div class="mb-3 ps-2 fs-13px">\n                  <b>SEBARAN ALOKASI ANGGARAN DAK FISIK</b>\n                  <span class="ms-2 text-muted">\n                    <i class="fa fa-info-circle" data-bs-toggle="popover" data-bs-trigger="hover"\n                      data-bs-title="Sebaran Alokasi Anggaran DAK Fisik" data-bs-placement="top"\n                      data-bs-content="Sebaran Alokasi Anggaran DAK Fisik." data-original-title="" title="">\n                      </i>\n                  </span>\n                </div>\n              </div>\n              <div class="col-sm-2 col-xl-1">\n                <div class="form-group mt-n2">\n                  <select class="selectpicker" id="tahun-group" title="Tahun" data-style="btn-white" data-selected-text-format="count > 2" data-actions-box="true"  \n                    data-selected-text-format="count > 2" data-width='100%' data-actions-box="false">\n                    <option value="2021" selected>2021</option>\n                    <option value="2020">2020</option>\n                    <option value="2019">2019</option>\n                  </select>\n                </div>\n              </div>\n              <div class="col-sm-10 col-xl-4">\n                <div class="form-group mt-n2 ms-n1 me-2">\n                  <select class="selectpicker" id="bidang-group" title="Bidang Kegiatan"\n                    data-style="btn-white" data-selected-text-format="count > 2" data-width='100%' data-multiple-separator=' ' data-select-all-text='Semua' data-deselect-all-text='Reset' data-actions-box="true" multiple\n                    data-selected-text-format="count > 2" data-actions-box="true" multiple>\n                    <option data-icon="text-yellow fa fa-circle" value="Kesehatan dan KB" selected>Kesehatan dan KB</option>\n                    <option data-icon="text-primary fa fa-circle" value="Air Minum" selected>Air Minum</option>\n                    <option data-icon="text-success fa fa-circle" value="Sanitasi">Sanitasi</option>\n                    <option data-icon="text-warning fa fa-circle" value="Lingkungan Hidup dan Kehutanan">Lingkungan Hidup dan Kehutanan</option>\n                  </select>\n                </div>\n              </div>\n            </div>          \n            <div class="row px-3">\n              <div  id="map-dak" class="col-xl-12 col-12" ></div>\n            </div>            \n          </div>\n          <div class="row my-3">\n            <div class="col-xl-6 col-6 " >\n              <div class="card" >\n                <div class="card-body me-1">\n                  <div class="mb-2 fs-13px">\n                    <b>BIDANG</b>\n                    <span class="ms-2 text-muted">\n                      <i class="fa fa-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Pemetaan Berdasarkan Bidang" data-bs-placement="top" data-bs-content="Menampilkan data alokasi berdasarkan Bidang DAK." data-bs-original-title="" title=""></i>\n                    </span>\n                  </div>\n                  <div id="chart-bidang" class="mb-2" style="height: 200px"></div>\n                </div>\n              </div>\n            </div>\n            <div class="col-xl-6 col-6" >\n              <div class=" card" >\n                <div class="card-body ms-1">\n                  <div class="mb-2 fs-13px">\n                    <b>REALISASI BERDASARKAN TAHUN</b>\n                    <span class="ms-2 text-muted">\n                      <i class="fa fa-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-title="Realisasi berdasarkan tahun" data-bs-placement="top" data-bs-content="Menampilkan data realisasi DAK berdasarkan tahun." data-bs-original-title="" title=""></i>\n                    </span>\n                  </div>\n                  <div id="chart-realisasi" class="mb-2" style="height: 200px"></div>\n                </div>\n              </div>               \n            </div>               \n          </div>\n          <div class="card">\n            <div class="card-body">\n              <div class="row pt-3 mx-0 mb-3 py-3 bg-gray-300 rounded" id="drp_option">\n                <div class="col-xl-3 ">\n                  <div class="form-group sel_tax">                  \n                    <select id="sel_ta" name="sel_ta" class="form-control selectpicker" data-title="Pilih Tahun" data-actions-box="true" data-select-all-text="Pilih Semua" data-deselect-all-text="Reset">\n                    </select>                    \n                  </div>\n                </div>\n                <div class="col-xl-9">\n                  <div class="form-group sel_tp">\n                    <select id="sel_tp" name="sel_tp" class="form-control selectpicker" data-toggle="dropdown" data-title="Pilih Tingkat Pelaksanaan" data-actions-box="true" multiple="" data-selected-text-format="count > 2" data-select-all-text="Pilih Semua" data-deselect-all-text="Reset" data-count-selected-text="{0} Tingkat Pelaksanaan dipilih">\n                    </select>\n                  </div>\n                </div>\n                <div class="col-xl-3 hide">\n                  <div class="form-group sel_provinsi">                  \n                    <select id="sel_provinsi" name="sel_provinsi" class="form-control selectpicker" data-live-search="true" data-title="Pilih Intervensi" data-show-subtext="true" data-actions-box="true" multiple="" data-selected-text-format="count > 2" data-select-all-text="Pilih Semua" data-deselect-all-text="Reset" data-count-selected-text="{0} Provinsi dipilih">\n                    </select>                  \n                  </div>\n                </div>\n                <div class="col-xl-3 hide">\n                  <div class="form-group sel_pemda">                  \n                    <select id="sel_pemda" name="sel_pemda" class="form-control selectpicker" data-live-search="true" data-title="Pilih Intervensi" data-show-subtext="true" data-actions-box="true" multiple="" data-selected-text-format="count > 2" data-select-all-text="Pilih Semua" data-deselect-all-text="Reset" data-count-selected-text="{0} Pemda dipilih">\n                    </select>\n                  </div>\n                </div>                \n                \x3c!-- <div class="col-xl-1 ">\n                    <div class="form-group pull-right width-full">              \n                      <div class="menu-icon btn btn-primary m-0 p-0 px-2" data-bs-toggle="modal" data-bs-target="#chartModal" >\n                        <i class="material-icons fs-29px">bar_chart</i>\n                      </div>\n                    </div>\n                </div> --\x3e\n              </div>\n              <div class="d-flex justify-content-between bd-highlight" style="height: 2em;">\n                <div class="bd-highlight mt-n1 fs-11px fw-600">\n                  <div class="d-flex flex-row hide" id="provkab">\n                    <div class="form-check-inline bd-highlight ps-1 me-1">Filter By :</div>\n                    <div class="form-group bd-highlight">                  \n                      <select id="provkabG" name="provkab" class="form-control selectpicker" data-title="Pilih Intervensi" data-show-subtext="true" data-actions-box="true" multiple="" data-selected-text-format="count > 2" data-select-all-text="Pilih Semua" data-deselect-all-text="Reset" data-count-selected-text="{0} Pemda dipilih">\n                        <option value="Provinsi" selected="selected"> Provinsi </option>\n                        <option value="Kota/ Kabupaten" selected="selected"> Kota/Kabupaten </option>\n                      </select>\n                    </div>\n                  </div>\n                </div>\n                <div class="d-flex flex-row bd-highlight flex-row-reverse fw-600 text-gray-700 my-2 mt-n1 fs-11px">\n                  <div class="bd-highlight">\n                    <i class="fas fa-lg fa-fw fa-file-pdf p-0 m-0 cursor-pointer fs-15px text-red-400" title="export pdf" id="download-pdf-dak"></i>\n                  </div>  \n                  <div class="bd-highlight">\n                    <i class="fas fa-lg fa-fw fa-file-excel p-0 m-0 cursor-pointer fs-15px text-green-400" title="export xls" id="download-xlsx-dak"></i>\n                  </div>    \n                  <div class="bd-highlight">\n                    <div class="fs-12px fw-700">Download : </div>\n                  </div>        \n                </div>\n              </div>\n              <div id="dak-table" class="rounded-bottom"></div>  \n            </div>        \n          </div>\n        </div>\n      </div>\n    </div>`},after_render:async()=>{const tile1=document.getElementById("tile-1"),tile2=document.getElementById("tile-2"),tile3=document.getElementById("tile-3"),tile4=document.getElementById("tile-4");mData.dataDak=void 0===mData.dataDak?await apiAnggaranDak():mData.dataDak,mData.tahunDAK=void 0===mData.tahunDAK?await ApiTahunDAK():mData.tahunDAK,mData.dataByTahun=void 0===mData.dataByTahun?await ApiDataByTahun():mData.dataByTahun,mData.DakPeta=void 0===mData.DakPeta?await ApiDakPeta():mData.DakPeta;let currentYear=2021,thID=document.getElementById("sel_ta"),tpID=document.getElementById("sel_tp"),pemdaID=document.getElementById("sel_pemda"),provID=document.getElementById("sel_provinsi"),dTahun=[],dTp=[],dPemda=[],dProv=[],ftingkat_pelaksanaan=6,fpemda=11,fprovinsi=12,ftahun=0,fbidang=1,fsubbidang=2,fkegiatan=4,falokasi=10,fvolumn=7,fsatuan=8,fkementerian=3,fnilai=9,fjenis=5,fkewenangan=13,frincian=14;if(void 0===mData.GrpBidang){let byBidang=arr_groupBy([1]);mData.GrpBidang=byBidang(mData.dataDak)}async function getDataByTingpel(currentYearx){(new FormData).append("tahun[]",currentYearx);try{let res=await fetch(config.api_url+"/dak/data-by-bidang",{method:"POST",body:JSON.stringify({tahun:[currentYearx]}),headers:config.fetchHeaders}),_res=await res.json();return $("#chart-bidang").parent().find("b").html("Bidang Tahun "+currentYearx),_res.data}catch(e){return!1}}if(void 0===mData.filterBidang&&(mData.filterBidang=Object.keys(mData.GrpBidang)),void 0===mData.DataByTingpel){let data;await getDataByTingpel(currentYear).then((function(a){data=a})),mData.DataByTingpel=data}function chartBar(dataX){let a=dataX,chart=am4core.create("chart-bidang",am4charts.PieChart),dChart=[];a.forEach(val=>{dChart.push({bidang_kode:val.bidang_kode,bidang_nama:val.bidang_nama,grand_total:parseFloat((val.grand_total/1e12).toFixed(2))})}),chart.data=dChart;var pieSeries=chart.series.push(new am4charts.PieSeries);pieSeries.dataFields.value="grand_total",pieSeries.dataFields.category="bidang_nama",chart.innerRadius=am4core.percent(40),pieSeries.labels.template.disabled=!0,pieSeries.labels.template.maxWidth=130,pieSeries.labels.template.wrap=!0,pieSeries.ticks.template.disabled=!0,pieSeries.slices.template.tooltipText="{category}: {value.value}T",pieSeries.colors.list=[am4core.color("#eb72a2"),am4core.color("#44b5de"),am4core.color("#845EC2"),am4core.color("#2eb6ac"),am4core.color("#D65DB1"),am4core.color("#FF6F91"),am4core.color("#FF9671"),am4core.color("#FFC75F"),am4core.color("#F9F871")],chart.legend=new am4charts.Legend,chart.fontSize=12,chart.legend.position="right",exportAmchart4(chart)}$("#chart-bidang").parent().find("b").html("Bidang Tahun "+currentYear),chartBar(mData.DataByTingpel),$("#tahun-group").on("change",(async function(){let xy,val=$(this).val();return await getDataByTingpel(val).then((function(a){xy=a})),mData.DataByTingpel=xy,chartBar(mData.DataByTingpel)}));let z=mData.dataByTahun;if(am4core.ready((function(){am4core.useTheme(am4themes_animated);var chart=am4core.create("chart-realisasi",am4charts.XYChart);chart.legend=new am4charts.Legend,chart.legend.position="bottom",chart.legend.paddingBottom=0,chart.legend.labels.template.maxWidth=10,chart.fontSize=12;var xAxis=chart.xAxes.push(new am4charts.CategoryAxis),yAxis;function createSeries(name,value){var series=chart.series.push(new am4charts.ColumnSeries);return series.dataFields.valueY=value,series.dataFields.categoryX="tahun",series.name=name,series.tooltipText="{name}: [bold]{valueY}T[/]",series.events.on("hidden",arrangeColumns),series.events.on("shown",arrangeColumns),series}xAxis.dataFields.category="tahun",xAxis.renderer.cellStartLocation=.1,xAxis.renderer.cellEndLocation=.9,xAxis.renderer.grid.template.location=0,xAxis.renderer.minGridDistance=50,chart.yAxes.push(new am4charts.ValueAxis).min=0;let dChart=[];function arrangeColumns(){var series=chart.series.getIndex(0),w=1-xAxis.renderer.cellStartLocation-(1-xAxis.renderer.cellEndLocation);if(series.dataItems.length>1){var x0=xAxis.getX(series.dataItems.getIndex(0),"categoryX"),x1,delta=(xAxis.getX(series.dataItems.getIndex(1),"categoryX")-x0)/chart.series.length*w;if(am4core.isNumber(delta)){var middle=chart.series.length/2,newIndex=0;chart.series.each((function(series){series.isHidden||series.isHiding?series.dummyData=chart.series.indexOf(series):(series.dummyData=newIndex,newIndex++)}));var visibleCount,newMiddle=newIndex/2;chart.series.each((function(series){var trueIndex=chart.series.indexOf(series),newIndex,dx=(series.dummyData-trueIndex+middle-newMiddle)*delta;series.animate({property:"dx",to:dx},series.interpolationDuration,series.interpolationEasing),series.bulletsContainer.animate({property:"dx",to:dx},series.interpolationDuration,series.interpolationEasing)}))}}}z.chart_data.forEach(val=>{dChart.push({nilai_rk:parseFloat((val.nilai_rk/1e12).toFixed(2)),realisasi:parseFloat((val.realisasi/1e12).toFixed(2)),tahun:val.tahun})}),chart.data=dChart,createSeries("Alokasi","nilai_rk"),createSeries("Realisasi","realisasi"),chart.adapter.add("tooltipText",(function(text,ev){return ev.dataItem.dataContext.value?text:"{name}: No value"})),chart.cursor=new am4charts.XYCursor,exportAmchart4(chart)})),currentYear=Math.max(...mData.tahunDAK),void 0===mData.PageData){async function getPageData(){var formdata;(new FormData).append("tahun[]",currentYear);try{let res=await fetch(config.api_url+"/dak/one-page",{method:"POST",body:JSON.stringify({tahun:[currentYear]}),headers:config.fetchHeaders}),_res;return(await res.json()).data}catch(e){return!1}}let datax;await getPageData().then((function(x){datax=x})),mData.PageData=datax}let x=mData.PageData;mData.dak_total_anggaran=x.total_dak,mData.dak_total_anggaran_before=x.total_dak_before,mData.dak_selisih=x.total_dak-x.total_dak_before,mData.dak_selisih_persen=(x.total_dak-x.total_dak_before)/x.total_dak_before*100,tile1.innerHTML=`\n      <p id="dak-total-anggaran" class="h2 mb-0 text-green" \n        data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="left" \n        data-bs-content="${parseFloat((mData.dak_total_anggaran/1).toFixed(0)).toLocaleString("id-ID")}"> \n        ${parseFloat((mData.dak_total_anggaran/1e12).toFixed(3)).toLocaleString("id-ID")} T\n      </p>\n      <p id="dak-total-anggaran-before" class="fs-13px mb-0 text-gray-700">\n        <span class="text-${mData.dak_selisih>0?"success":"danger"} fs-bold">\n          <i class="fa fa-caret-${mData.dak_selisih>0?"up":"down"}"></i>\n          <b> ${parseFloat(mData.dak_selisih_persen.toFixed(2)).toLocaleString("id-ID")}%</b>\n        </span> \n        dari tahun sebelumnya <span class="fw-bold" data-bs-toggle="popover" data-bs-trigger="hover" \n          data-bs-placement="top" data-bs-content="${parseFloat((mData.dak_total_anggaran_before/1).toFixed(0)).toLocaleString("id-ID")}"> \n          ${parseFloat((mData.dak_total_anggaran_before/1e12).toFixed(3)).toLocaleString("id-ID")} T</span>\n      </p>\n      <hr class="my-3"/>\n      <div class="row text-truncate">\n        \x3c!-- BEGIN col-6 --\x3e\n        <div class="col-6">\n          <div class="fs-12px">Tingkat Provinsi</div>\n          <div id="tile-1-tingpel-prov" class="h6 mb-2px fw-bold text-primary" ><i class="fas fa-circle-notch fa-spin"></i></div>\n          <div class="progress h-5px rounded-3 mt-2 mb-0">\n            <div class="progress-bar progress-bar-striped rounded-right " data-animation="width" data-value="100%" style="width: 100%"></div>\n          </div>\n        </div>\n        \x3c!-- END col-6 --\x3e\n        \x3c!-- BEGIN col-6 --\x3e\n        <div class="col-6">\n          <div class="fs-12px">Tingkat Kab/Kota</div>\n          <div id="tile-1-tingpel-kot" class="h6 mb-2px fw-bold text-warning"><span><i class="fas fa-circle-notch fa-spin"></i></span></div>\n          <div class="progress h-5px rounded-3 mt-2 mb-0">\n            <div class="progress-bar progress-bar-striped rounded-right bg-orange" data-animation="width" data-value="100%" style="width: 100%"></div>\n          </div>\n        </div>\n        \x3c!-- END col-6 --\x3e\n      </div>`,$("#tile-1-tingpel-prov").html(parseFloat((x.tingpel[0].grand_total/1e12).toFixed(3)).toLocaleString("id-ID")+' T <span class="fw-600 fs-9px">('+(parseFloat(x.tingpel[0].grand_total)/parseFloat(x.total_dak)*100).toLocaleString("id-ID")+"%)</span>"),$("#tile-1-tingpel-kot").html(parseFloat((x.tingpel[1].grand_total/1e12).toFixed(3)).toLocaleString("id-ID")+' T <span  class="fw-600 fs-9px">('+(parseFloat(x.tingpel[1].grand_total)/parseFloat(x.total_dak)*100).toLocaleString("id-ID")+"%)</span>"),tile2.innerHTML='\n      <div class="row">\n        <div class="col">\n          <p class="h4 mb-5px text-black-transparent-7"><span id="total-prov" class="h2 text-blue"></span> Provinsi</p>\n          <div id="top-5-prov" class="fs-13px mt-3"></div>\n        </div>\n        <div class="col">\n          <p class="h4 mb-5px text-black-transparent-7"><span id="total-pemda" class="h2 text-orange"></span> Kota/Kab</p>\n          <div id="top-5-pemda" class="fs-13px mt-3"></div>\n        </div>\n      </div>',tile4.innerHTML='\n      <div class="d-flex align-items-center mb-1">\n        <h3 class="mb-0"><span id="tahun-total" class="text-green-600"><i class="fas fa-circle-notch fa-spin"></i></span></h4>\n        <div class="ms-auto">\n          <div id="store-session-sparkline"></div>\n        </div>\n      </div>\n      <div class="mb-3">\n      </div>\n      <div class="d-flex mb-2">        \n      </div>\n      <div id="tahun-list" class="fs-13px"></div>',$("#total-kl").html(x.kl_only.length);let html1="";x.data_kl.forEach((function(kl,i){html1+='<div class="d-flex py-1 mb-0 border-top"><div class="d-flex align-items-center"><i class="fa fa-circle text-red fs-8px me-2"></i>'+kl.kementerian_nama+'</div><div class="d-flex align-items-center ms-auto"><div class="w-120px text-end ps-12 text-gray-700 fw-bold"><span data-bs-toggle="popover" style="cursor:pointer" data-bs-trigger="hover" data-bs-title="'+kl.kementerian_nama+'" data-bs-placement="top" data-bs-content="'+kl.grand_total.toLocaleString("id-ID")+'">'+(kl.grand_total/1e9).toLocaleString("id-ID")+" M</span></div></div></div>",$("#top-3-kl").html(html1)})),$("#total-prov").html(x.prov_count_all),$("#total-pemda").html(x.pemda_count_all);let html2="";x.top_5_prov.forEach((function(prov,i){html2+='<div class="d-flex border-top"><div class="d-flex align-items-center align-middle"><i class="fa fa-circle text-blue fs-8px me-2"></i>'+prov.prov_nama+'</div><div class="d-flex align-items-center ms-auto"><div class="w-120px text-end ps-12 fw-500"><span data-bs-toggle="popover" style="cursor:pointer" data-bs-trigger="hover" data-bs-title="'+prov.prov_nama+'" data-bs-placement="top" data-bs-content="'+prov.grand_total.toLocaleString("id-ID")+'">'+(prov.grand_total/1e9).toLocaleString("id-ID")+" M</span></div></div></div>",$("#top-5-prov").html(html2)}));let html3="";x.top_5_pemda.forEach((function(pemda,i){html3+='<div class="d-flex border-top"><div class="d-flex align-items-center"><i class="fa fa-circle text-warning fs-8px me-2"></i>'+pemda.pemda_nama+'</div><div class="d-flex align-items-center ms-auto"><div class="w-120px text-end ps-12 fw-500"><span data-bs-toggle="popover" style="cursor:pointer" data-bs-trigger="hover" data-bs-title="'+pemda.pemda_nama+'" data-bs-placement="top" data-bs-content="'+pemda.grand_total.toLocaleString("id-ID")+'">'+(pemda.grand_total/1e9).toLocaleString("id-ID")+" M</span></div></div></div>",$("#top-5-pemda").html(html3)}));let html4="";var totalAllTahun=0;let thn;x.data_3_tahun.forEach((function(objTahun,i){var selisih="";null!=objTahun.seilsih_before&&(selisih='<div class="fs-12px mx-3 '+(objTahun.seilsih_before>0?"text-success":"text-danger")+'"><i class="fa '+(objTahun.seilsih_before>0?"fa-caret-up":"fa-caret-down")+'"></i> <span data-animation="number" data-value="'+objTahun.seilsih_before+'">'+parseFloat(objTahun.seilsih_before.toFixed(2)).toLocaleString("id-ID")+"</span>%</div>"),html4+='<div class="d-flex mb-2"><div class="d-flex align-items-center"><i class="fa fa-circle text-red fs-8px me-2"></i>'+objTahun.tahun+'</div><div class="d-flex align-items-center ms-auto">'+selisih+'<div class="w-120px text-end ps-12 fw-bold text-gray-700"><span data-bs-toggle="popover" style="cursor:pointer" data-bs-trigger="hover" data-bs-title="'+objTahun.tahun+'" data-bs-placement="top" data-bs-content="'+objTahun.grand_total.toLocaleString("id-ID")+'">'+parseFloat((objTahun.grand_total/1e12).toFixed(2)).toLocaleString("id-ID")+" T</span></div></div></div>",$("#tahun-list").html(html4),totalAllTahun+=objTahun.grand_total})),$("#tahun-total").html(parseFloat((totalAllTahun/1e12).toFixed(2)).toLocaleString("id-ID")+" T"),$("[data-bs-toggle=popover]").popover(),mData.dataByTahun.chart_data.forEach(item=>{dTahun.push(`<option value="${item.tahun}" ${item.tahun==currentYear?"selected='selected'":""} >${item.tahun}</option>`)}),thID.innerHTML=dTahun.join(" "),mData.PageData.tingpel.forEach(item=>{dTp.push(`<option value="${item.tingkat_pelaksanaan}" selected="selected" >${item.tingkat_pelaksanaan}</option>`)}),tpID.innerHTML=dTp.join(" "),mData.PageData.pemda.forEach(item=>{dPemda.push(`<option value="${item.pemda_kode+"-"+item.pemda_nama}" selected="selected" >${item.pemda_kode+"-"+item.pemda_nama}</option>`)}),pemdaID.innerHTML=dPemda.join(" "),mData.PageData.provinsi.forEach(item=>{dProv.push(`<option value="${item.prov_kode+"-"+item.prov_nama}" selected="selected" >${item.prov_kode+"-"+item.prov_nama}</option>`)}),provID.innerHTML=dProv.join(" "),$("#provkabG").on("change",(async function(){let provkab=$(this).val(),kf=[];mData.dataDakHistory.filter((async function(ef){!provkab.includes(ef[6].trim())||["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(ef[2].trim())||["All"].includes(ef[13])||kf.push(ef)})),dataTableDAK(kf)})),$("#sel_tp").on("change",(async function(){let kat=$(this).val();kat.includes("Provinsi")&&1===kat.length?($("#sel_tp").parent().parent().parent().removeClass("col-xl-9").addClass("col-xl-3"),$("#sel_provinsi,#sel_pemda").parent().parent().parent().removeClass("hide")):kat.includes("Kota/ Kabupaten")&&1===kat.length?($("#sel_tp").parent().parent().parent().removeClass("col-xl-9").addClass("col-xl-3"),$("#sel_provinsi").parent().parent().parent().addClass("hide"),$("#sel_pemda").parent().parent().parent().removeClass("hide"),$("#sel_pemda").parent().parent().parent().removeClass("col-xl-3").addClass("col-xl-6")):(kat.length,$("#sel_tp").parent().parent().parent().removeClass("col-xl-3").addClass("col-xl-9"),$("#sel_provinsi,#sel_pemda").parent().parent().parent().addClass("hide"),$("#sel_provinsi,#sel_pemda").parent().parent().parent().removeClass("col-xl-6").addClass("col-xl-3"))})),$("#sel_provinsi").on("change",(async function(){$("#provkabG").find("option").attr("selected","selected");let ta=$("#sel_ta").val(),prv=$(this).val(),e=[],f=[],g=[];pemdaID.innerHTML="",mData.PageData.pemda.forEach(item=>{prv.includes(item.provinsi)&&(e.push(`<option value="${item.pemda_kode+"-"+item.pemda_nama}" selected="selected" >${item.pemda_kode+"-"+item.pemda_nama}</option>`),f.push(item.pemda_kode+"-"+item.pemda_nama))}),pemdaID.innerHTML=e.join(" "),$("#sel_pemda").selectpicker("refresh"),mData.dataDak.filter((async function(h){ta.includes(h[0].trim())&&prv.includes(h[12].trim())&&!["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(h[2].trim())&&!["All"].includes(h[13])&&g.push(h)})),$("#provkabG").selectpicker("selectAll"),mData.dataDakHistory=g,dataTableDAK(g)})),$("#sel_pemda").on("change",(async function(){let ta=$("#sel_ta").val(),pm=$(this).val(),prv=$("#sel_provinsi").val(),h=[];$("#provkabG").find("option").attr("selected","selected"),mData.dataDak.filter((async function(j){ta.includes(j[0].trim())&&prv.includes(j[12].trim())&&pm.includes(j[11].trim())&&!["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(j[2].trim())&&!["All"].includes(j[13])&&h.push(j)})),$("#provkabG").selectpicker("selectAll"),mData.dataDakHistory=h,dataTableDAK(h)})),$("#sel_tp").on("change",(async function(){let ta=$("#sel_ta").val(),tp=$("#sel_tp").val(),pm=$("#sel_pemda").val(),d=[];mData.dataDak.filter((async function(e){(2!==tp.length||!ta.includes(e[0])||["All"].includes(e[13])||["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(e[2].trim()))&&(1!==tp.length||"Provinsi"!==tp.toString()||!ta.includes(e[0].trim())||["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(e[2].trim())||["All"].includes(e[13]))?1===tp.length&&"Kota/ Kabupaten"===tp.toString()&&ta.includes(e[0].trim())&&pm.includes(e[11].trim())&&!["All"].includes(e[13])&&!["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(e[2].trim())&&d.push(e):d.push(e)})),"Kota/ Kabupaten"===tp.toString()||2===tp.length?$("#provkab").addClass("hide"):($("#sel_pemda").find("option").attr("selected","selected"),$("#sel_pemda").selectpicker("selectAll"),$("#provkab").removeClass("hide")),mData.dataDakHistory=d,dataTableDAK(d)})),$("#sel_ta").on("change",(async function(){let ta=$(this).val(),ef=[];mData.dataDak.filter((async function(e){!ta.includes(e[0])||["All"].includes(e[13])||["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(e[2].trim())||ef.push(e)})),$("#sel_tp").parent().parent().parent().removeClass("col-xl-3").addClass("col-xl-9"),$("#sel_provinsi,#sel_pemda").parent().parent().parent().addClass("hide"),$("#sel_provinsi,#sel_pemda").parent().parent().parent().removeClass("col-xl-6").addClass("col-xl-3"),$("#provkab").addClass("hide"),$("#sel_pemda,#sel_tp,#sel_provinsi,#sel_pemda").selectpicker("selectAll"),dataTableDAK(ef)}));let dy=[];async function dataTableDAK(dx){let a=[],i=1,unique_ftahun=[...new Set(dx.map(item=>item[0]))],unique_fbidang=[...new Set(dx.map(item=>item[1]))],bid2019=unique_fbidang.filter(bidd=>"15-Lingkungan Hidup dan Kehutanan"!==bidd),bid2020=unique_fbidang.filter(bidd=>"14-Lingkungan Hidup dan Kehutanan"!==bidd);var thn_unique_fbidang=unique_fbidang;"2019"===unique_ftahun.toString()?thn_unique_fbidang=bid2019:"2020"===unique_ftahun.toString()&&(thn_unique_fbidang=bid2020);for(let bid of thn_unique_fbidang){let aa=0,bb=[];dx.forEach(rowa=>{[bid].includes(rowa[1])&&(aa+=rowa[9],bb.push(rowa))});const b=[],unique_subbid=[...new Set(bb.map(item=>item[2]))];for(let subbid of unique_subbid){let aaa=0,bbb=[];bb.forEach(rowb=>{[subbid].includes(rowb[2])&&(aaa+=rowb[9],bbb.push(rowb))});const c=[],unique_kegiatan=[...new Set(bbb.map(item=>item[4]))];for(let keg of unique_kegiatan){let aaaa=0,bbbb=[];bbb.forEach(rowc=>{[keg].includes(rowc[4])&&(aaaa+=rowc[9],bbbb.push(rowc))});const e=[],unique_rincian=[...new Set(bbbb.map(item=>item[14]))];for(let rinc of unique_rincian){let aaaaa=0,sat,vol;bbbb.forEach(rowd=>{[rinc].includes(rowd[14])&&(aaaaa+=rowd[9],sat=rowd[8],vol=rowd[7])}),e.push({name:"  "+rinc,nilai:aaaaa,satuan:sat,volumn:vol})}c.push({name:"  "+keg,nilai:aaaa,satuan:"",volumn:"",_children:e})}b.push({name:" "+subbid,nilai:aaa,satuan:"",volumn:"",_children:c})}a.push({no:i++,name:bid,nilai:aa,satuan:"",volumn:"",_children:b})}const table=new Tabulator("#dak-table",{data:a,index:"id",layout:"fitDataStretch",columnHeaderVertAlign:"middle",dataTree:!0,dataTreeStartExpanded:!1,dataTreeFilter:!0,dataTreeElementColumn:"name",dataTreeChildColumnCalcs:!1,dataTreeSelectPropagate:!0,dataLoader:!1,movableColumns:!0,columns:[{title:"Bidang/Sub Bidang/Kegiatan/Rincian",field:"name",visible:!0,width:500,sorter:"string",hozAlign:"left",headerHozAlign:"left",frozen:!0},{title:"Nilai RK",field:"nilai",visible:!0,bottomCalc:"sum",width:250,bottomCalcFormatter:"money",bottomCalcFormatterParams:{decimal:",",thousand:".",symbol:"",symbolAfter:"",precision:0},sorter:"number",hozAlign:"right",headerHozAlign:"right",formatter:"money",formatterParams:{decimal:",",thousand:".",symbol:"",symbolAfter:"",precision:0}},{title:"Satuan",field:"satuan",visible:!0,sorter:"number",hozAlign:"center",headerHozAlign:"center"},{title:"Volumn",field:"volumn",visible:!0,formatter:"money",formatterParams:{decimal:",",thousand:".",symbol:"",symbolAfter:"",precision:0},sorter:"number",hozAlign:"right",headerHozAlign:"right"}],initialSort:[{column:"name",dir:"asc"}]});return document.getElementById("download-xlsx-dak").addEventListener("click",(function(){table.download("xlsx","Dana_Alokasi_Khusus.xlsx",{sheetName:"data"})})),document.getElementById("download-pdf-dak").addEventListener("click",(function(){table.download("pdf","Dana Alokasi Khusus.pdf",{orientation:"landscape",title:"Dana Alokasi Khusus",unit:"in",format:"tabloid",autoTable:function(doc){return{styles:{fontsize:7},columnStyles:{0:{cellWidth:450},1:{halign:"right"},2:{halign:"center"},3:{halign:"right"}}}},documentProcessing:function(doc){}})})),table}mData.dataDak.filter((async function(e){![currentYear.toString()].includes(e[0])||["All"].includes(e[13])||["06-Penguatan Penurunan Angka Kematian Ibu dan Bayi"].includes(e[2].trim())||dy.push(e)})),dataTableDAK(dy);const geojsonMarkerGreen_radius=3,geojsonMarkerGreen_fillColor="MediumSeaGreen",geojsonMarkerGreen_color="#000",geojsonMarkerGreen_weight=.5,geojsonMarkerGreen_opacity=1,geojsonMarkerGreen_fillOpacity=.8,geojsonMarkerBlue={radius:3,fillColor:"blue",color:"#000",weight:.5,opacity:1,fillOpacity:.8},geojsonMarkerYellow={radius:3,fillColor:"yellow",color:"#000",weight:.5,opacity:1,fillOpacity:.8},geojsonMarkerOrange_radius=3,geojsonMarkerOrange_fillColor="orange",geojsonMarkerOrange_color="#000",geojsonMarkerOrange_weight=.5,geojsonMarkerOrange_opacity=1,geojsonMarkerOrange_fillOpacity=.8,geojsonMarkerRed_radius=3,geojsonMarkerRed_fillColor="red",geojsonMarkerRed_color="#000",geojsonMarkerRed_weight=.5,geojsonMarkerRed_opacity=1,geojsonMarkerRed_fillOpacity=.8,geojsonMarkerBrown={radius:3,fillColor:"#dd7f2a",color:"#000",weight:.5,opacity:1,fillOpacity:.8},geojsonMarkerDarkGreen={radius:3,fillColor:"darkgreen",color:"#000",weight:.5,opacity:1,fillOpacity:.8},provinsiStyle={fillColor:"#FFB230",color:"#FFFFFF",weight:1,fillOpacity:.9};var lokasiGeoDataX,fuse=null;function initMap(){const btnHomeReset=L.Control.extend({options:{position:"topleft"},onAdd:function(map){var container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom btn btn-light p-0");return container.title="Reset Posisi Peta",container.type="button",container.style.backgroundImage="url(img/home.png)",container.style.backgroundSize="30px 30px",container.style.width="33px",container.style.height="33px",container.onclick=function(){map.fitBounds(provinsiLayer.getBounds())},container}}),legend=L.control({position:"bottomleft"});let selectedStates,map=L.map("map-dak",{attributionControl:!1}).setView([-2,117],5);map.addControl(new btnHomeReset),legend.onAdd=function(map){var div=L.DomUtil.create("div","legend");return div.innerHTML+="<h4>Bidang Kegiatan</h4>",div.innerHTML+='<i style="background-color: yellow"></i><span>Kesehatan dan KB</span><br>',div.innerHTML+='<i style="background-color: blue"></i><span>Air Minum</span><br>',div.innerHTML+='<i style="background-color: darkgreen"></i><span>Sanitasi</span><br>',div.innerHTML+='<i style="background-color: #dd7f2a"></i><span>Lingkungan Hidup dan Kehutanan</span><br>',div},map.addControl(L.control.fullscreen({position:"topright",forceSeparateButton:!0,fullscreenElement:document.getElementById("fbody")})),map.on("enterFullscreen",(function(){$("#map-dak").addClass("fullscreen-map-dak"),$("#fbody").addClass(["p-2","bg-white"])})),map.on("exitFullscreen",(function(){$("#fbody").removeClass(["p-2","bg-white"]),$("#map-dak").removeClass("fullscreen-map-dak")})),legend.addTo(map);const search=new GeoSearch.GeoSearchControl({provider:new GeoSearch.OpenStreetMapProvider({params:{"accept-language":"id",countrycodes:"id",addressdetails:0}}),showMarker:!1,searchLabel:"Pencarian Lokasi",style:"button",autoClose:!0,updateMap:!0});map.addControl(search);const baseLayer=L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',tileSize:512,maxZoom:20,zoomOffset:-1,id:"mapbox/streets-v11",accessToken:"pk.eyJ1IjoiYXJqaWFudG8iLCJhIjoiMjYxNWQ1YjkyMjIzMTdkMDE2ODJiNTBkYmE4MDcyNjAifQ.NvwfCpUvHeEiTXXcTJ3MfQ"}).addTo(map);let lokasiLayer=L.geoJSON(null,{filter:feature=>{let isTahunSelected=selectedStates.tahun.includes(feature.properties.tahun),isBidangSelected=selectedStates.bidang.includes(feature.properties.bidang_nama);return isTahunSelected&&isBidangSelected},pointToLayer:function(feature,latlng){switch(feature.properties.bidang_nama){case"Kesehatan dan KB":return L.circleMarker(latlng,geojsonMarkerYellow);case"Air Minum":return L.circleMarker(latlng,geojsonMarkerBlue);case"Sanitasi":return L.circleMarker(latlng,geojsonMarkerDarkGreen);case"Lingkungan Hidup dan Kehutanan":return L.circleMarker(latlng,geojsonMarkerBrown);default:return L.circleMarker(latlng,geojsonMarkerYellow)}},onEachFeature:popUpMarker}).addTo(map),provinsiLayer=L.geoJSON(provinsiGeoData,{style:provinsiStyle,onEachFeature:onEachFeature}).addTo(map);map.on("zoomend",(function(){map.getZoom()>=11&&map.hasLayer(provinsiLayer)&&map.removeLayer(provinsiLayer),map.getZoom()<11&&0==map.hasLayer(provinsiLayer)&&(map.addLayer(provinsiLayer),provinsiLayer.bringToBack())})),map.spin(!0),lokasiGeoDataX=mData.DakPeta,updateSelectedStates(),lokasiLayer.addData(lokasiGeoDataX),lokasiLayer.bringToFront(),map.spin(!1);let fuse=new Fuse(lokasiGeoDataX.features,{keys:["properties.provinsi_nama","properties.detail_rincian","properties.pemda_nama","properties.detail_rincian_nama"]});function highlightFeature(e){var layer;e.target.setStyle({weight:4,color:"#666",dashArray:"",fillOpacity:.4})}function resetHighlight(e){provinsiLayer.resetStyle(e.target),provinsiLayer.bringToBack()}function onEachFeature(f,l){f.properties&&(l.bindTooltip("<b>"+f.properties.name+"</b>"),l.on({mouseover:function(e){l.openTooltip(),map.closePopup()},click:function(e){zoomToFeature(e)},mouseout:function(e){}}))}function popUpMarker(f,l){var info="";if(f.properties){for(const key in f.properties)info=`\n            <span class='fs-6 fw-bold text-blue'><b>TA ${f.properties.tahun} </b></span><br/>\n            <span class='fs-5 text-green-700'> ${f.properties.pemda_nama} </span><br/>\n            <span class='fs-6 text-green-700'>\n              ${f.properties.provinsi_kode==f.properties.pemda_kode?"":"Provinsi "+f.properties.provinsi_nama}\n            </span>\n            <hr class='my-1'>\n            <div style="font-size:0.85rem">\n              <span >\n                <b>Bidang ${f.properties.bidang_nama} </b><br/>\n                <i style='font-size:0.775rem;'>Sub Bidang ${f.properties.sub_bidang_nama} </i>\n              </span><br/>\n              <b>Menu Kegiatan:</b><br>\n              <span style='font-size:0.775rem;'>${f.properties.menu_kegiatan_nama}</span><br/>\n              <b>Rincian:</b><br>\n              <span style='font-size:0.775rem;'>${f.properties.rincian_nama}</span><br/>\n              <b>Detail Rincian:</b><br>\n              <span style='font-size:0.775rem;'>${f.properties.detail_rincian_nama}</span><br/>\n              <span style='font-size:0.9rem;'>\n                <b>Volume </b> <span style='font-size:0.775rem;'>${f.properties.volume_rk} ${f.properties.satuan}</span><br/>\n                <b>Nilai </b> <span style='font-size:0.775rem;'>Rp ${f.properties.nilai_rk.toLocaleString("id-ID")}</span>\n              </span>\n              <hr class='my-1'>\n              <span>\n                <b>Latitute </b>${f.geometry.coordinates[1].toFixed(6)} | <b>Longtitude </b> ${f.geometry.coordinates[0].toFixed(6)} \n              </span><br>\n              <a href = 'https://www.google.com/maps?layer=c&cbll=${f.geometry.coordinates[1].toFixed(6)} , ${f.geometry.coordinates[0].toFixed(6)} &cbp=11,0,0,0,0' target = '_blank' id = 'infoBtn' class='btn btn-default btn-sm mt-1'>Street View</a></span>\n              </div>        \n              `;l.bindPopup(info,{minWidth:300,maxWidth:600,keepInView:!1}),l.on({mouseover:function(e){l.openPopup()},click:zoomToPoint})}}function zoomToFeature(e){map.fitBounds(e.target.getBounds())}function zoomToPoint(e){var l=e.target;map.flyTo([e.latlng.lat,e.latlng.lng],20,{animate:!0,duration:1}),l.openPopup()}function updateSelectedStates(){selectedStates={tahun:[],bidang:[]},selectedStates.tahun=$("#tahun-group").val(),selectedStates.bidang=$("#bidang-group").val()}L.control.search({layer:lokasiLayer,propertyName:"pemda_nama",filterData:function(text,records){var jsons=fuse.search(text),ret={},key;for(var i in jsons)ret[key=jsons[i].properties.pemda_nama]=records[key];return ret}}).on("search:locationfound",(function(e){e.layer.openPopup()})).addTo(map),$("#tahun-group").on("changed.bs.select",(function(e,clickedIndex,isSelected,previousValue){lokasiLayer.clearLayers(),updateSelectedStates(),lokasiLayer.addData(lokasiGeoDataX)})),$("#bidang-group").on("changed.bs.select",(function(e,clickedIndex,isSelected,previousValue){lokasiLayer.clearLayers(),updateSelectedStates(),lokasiLayer.addData(lokasiGeoDataX)}))}$(".selectpicker").selectpicker(),initMap()}};export default DAK;